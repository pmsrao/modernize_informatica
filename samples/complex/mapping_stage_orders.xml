<?xml version="1.0"?>
<MAPPING NAME="M_STAGE_ORDERS">
  <!-- Mapping: Stage order data with joins to customers and products
       Staging Layer: Complex joins and aggregations -->
  
  <!-- Source Qualifiers -->
  <TRANSFORMATION NAME="SQ_ORDERS" TYPE="SourceQualifier">
    <ATTRIBUTE NAME="Sql Query" VALUE="SELECT ORDER_ID, CUSTOMER_ID, ORDER_DATE, ORDER_STATUS, TOTAL_AMOUNT, SHIPPING_COST, TAX_AMOUNT FROM ORDERS WHERE ORDER_DATE >= TO_DATE('2024-01-01', 'YYYY-MM-DD')"/>
  </TRANSFORMATION>
  
  <TRANSFORMATION NAME="SQ_ORDER_ITEMS" TYPE="SourceQualifier">
    <ATTRIBUTE NAME="Sql Query" VALUE="SELECT ORDER_ITEM_ID, ORDER_ID, PRODUCT_ID, QUANTITY, UNIT_PRICE, DISCOUNT_PCT FROM ORDER_ITEMS"/>
  </TRANSFORMATION>
  
  <!-- Joiner: Orders with Order Items -->
  <TRANSFORMATION NAME="JNR_ORDERS_ITEMS" TYPE="Joiner">
    <JOINCONDITION LEFTFIELD="ORDER_ID" RIGHTFIELD="ORDER_ID" JOINTYPE="INNER"/>
  </TRANSFORMATION>
  
  <!-- Expression: Calculate order line totals -->
  <TRANSFORMATION NAME="EXP_CALC_TOTALS" TYPE="Expression">
    <TRANSFORMFIELD NAME="LINE_TOTAL" EXPR="QUANTITY * UNIT_PRICE"/>
    <TRANSFORMFIELD NAME="DISCOUNT_AMT" EXPR="LINE_TOTAL * (DISCOUNT_PCT / 100)"/>
    <TRANSFORMFIELD NAME="NET_AMOUNT" EXPR="LINE_TOTAL - DISCOUNT_AMT"/>
    <TRANSFORMFIELD NAME="ORDER_YEAR" EXPR="TO_CHAR(ORDER_DATE, 'YYYY')"/>
    <TRANSFORMFIELD NAME="ORDER_QUARTER" EXPR="TO_CHAR(ORDER_DATE, 'Q')"/>
    <TRANSFORMFIELD NAME="ORDER_MONTH" EXPR="TO_CHAR(ORDER_DATE, 'MM')"/>
  </TRANSFORMATION>
  
  <!-- Aggregator: Roll up to order level -->
  <TRANSFORMATION NAME="AGG_ORDER_SUMMARY" TYPE="Aggregator">
    <TRANSFORMFIELD NAME="TOTAL_LINES" EXPR="COUNT(ORDER_ITEM_ID)"/>
    <TRANSFORMFIELD NAME="TOTAL_QUANTITY" EXPR="SUM(QUANTITY)"/>
    <TRANSFORMFIELD NAME="TOTAL_AMOUNT" EXPR="SUM(NET_AMOUNT)"/>
    <TRANSFORMFIELD NAME="TOTAL_DISCOUNT" EXPR="SUM(DISCOUNT_AMT)"/>
    <GROUPBYFIELD NAME="ORDER_ID"/>
    <GROUPBYFIELD NAME="CUSTOMER_ID"/>
    <GROUPBYFIELD NAME="ORDER_DATE"/>
    <GROUPBYFIELD NAME="ORDER_STATUS"/>
  </TRANSFORMATION>
  
  <!-- Lookup: Customer information -->
  <TRANSFORMATION NAME="LK_CUSTOMER" TYPE="Lookup">
    <LOOKUPTABLE NAME="STAGE_CUSTOMERS"/>
    <LOOKUPFIELD NAME="CUSTOMER_ID" EXPR="CUSTOMER_ID"/>
    <RETURNFIELD NAME="CUSTOMER_KEY"/>
    <RETURNFIELD NAME="REGION_CODE"/>
  </TRANSFORMATION>
  
  <!-- Router: Split by order status -->
  <TRANSFORMATION NAME="RTR_BY_STATUS" TYPE="Router">
    <GROUP NAME="COMPLETED" CONDITION="ORDER_STATUS = 'COMPLETED'"/>
    <GROUP NAME="PENDING" CONDITION="ORDER_STATUS = 'PENDING'"/>
    <GROUP NAME="CANCELLED" CONDITION="ORDER_STATUS = 'CANCELLED'"/>
  </TRANSFORMATION>
  
  <!-- Filter: Only completed orders for staging -->
  <TRANSFORMATION NAME="FLT_COMPLETED" TYPE="Filter">
    <ATTRIBUTE NAME="Filter Condition" VALUE="ORDER_STATUS = 'COMPLETED'"/>
  </TRANSFORMATION>
  
  <!-- Target: Staging table -->
  <TARGET NAME="STAGE_ORDERS" TYPE="Target">
    <TABLE NAME="STAGE_ORDERS" DATABASENAME="STAGING_DB"/>
  </TARGET>
  
  <!-- Connectors -->
  <CONNECTOR FROMINSTANCE="SQ_ORDERS" FROMFIELD="*" TOINSTANCE="JNR_ORDERS_ITEMS" TOFIELD="*"/>
  <CONNECTOR FROMINSTANCE="SQ_ORDER_ITEMS" FROMFIELD="*" TOINSTANCE="JNR_ORDERS_ITEMS" TOFIELD="*"/>
  <CONNECTOR FROMINSTANCE="JNR_ORDERS_ITEMS" FROMFIELD="*" TOINSTANCE="EXP_CALC_TOTALS" TOFIELD="*"/>
  <CONNECTOR FROMINSTANCE="EXP_CALC_TOTALS" FROMFIELD="*" TOINSTANCE="AGG_ORDER_SUMMARY" TOFIELD="*"/>
  <CONNECTOR FROMINSTANCE="AGG_ORDER_SUMMARY" FROMFIELD="CUSTOMER_ID" TOINSTANCE="LK_CUSTOMER" TOFIELD="CUSTOMER_ID"/>
  <CONNECTOR FROMINSTANCE="AGG_ORDER_SUMMARY" FROMFIELD="*" TOINSTANCE="RTR_BY_STATUS" TOFIELD="*"/>
  <CONNECTOR FROMINSTANCE="LK_CUSTOMER" FROMFIELD="CUSTOMER_KEY" TOINSTANCE="RTR_BY_STATUS" TOFIELD="CUSTOMER_KEY"/>
  <CONNECTOR FROMINSTANCE="LK_CUSTOMER" FROMFIELD="REGION_CODE" TOINSTANCE="RTR_BY_STATUS" TOFIELD="REGION_CODE"/>
  <CONNECTOR FROMINSTANCE="RTR_BY_STATUS" FROMFIELD="COMPLETED.*" TOINSTANCE="FLT_COMPLETED" TOFIELD="*"/>
  <CONNECTOR FROMINSTANCE="FLT_COMPLETED" FROMFIELD="*" TOINSTANCE="STAGE_ORDERS" TOFIELD="*"/>
  
</MAPPING>

