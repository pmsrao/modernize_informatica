<?xml version="1.0"?>
<MAPPING NAME="M_STD_CUSTOMER_DATA">
  <!-- Mapping: Standardize customer data
       Standardization Layer: Apply business rules and data enrichment -->
  
  <!-- Source Qualifier: Read from staging -->
  <TRANSFORMATION NAME="SQ_STAGE_CUSTOMERS" TYPE="SourceQualifier">
    <ATTRIBUTE NAME="Sql Query" VALUE="SELECT * FROM STAGE_CUSTOMERS"/>
  </TRANSFORMATION>
  
  <!-- Lookup: Region mapping -->
  <TRANSFORMATION NAME="LK_REGION" TYPE="Lookup">
    <LOOKUPTABLE NAME="REGION_MASTER"/>
    <LOOKUPFIELD NAME="STATE" EXPR="STATE"/>
    <RETURNFIELD NAME="REGION_CODE"/>
    <RETURNFIELD NAME="REGION_NAME"/>
    <RETURNFIELD NAME="TIMEZONE"/>
  </TRANSFORMATION>
  
  <!-- Expression: Business logic and enrichment -->
  <TRANSFORMATION NAME="EXP_ENRICH" TYPE="Expression">
    <TRANSFORMFIELD NAME="CUSTOMER_KEY" EXPR="MD5(CUSTOMER_ID || EMAIL_UPPER)"/>
    <TRANSFORMFIELD NAME="CUSTOMER_SEGMENT" EXPR="IIF(REGION_CODE IN ('EAST', 'WEST'), 'PREMIUM', 'STANDARD')"/>
    <TRANSFORMFIELD NAME="CUSTOMER_TIER" EXPR="IIF(CREATED_DATE < ADD_TO_DATE(SYSDATE, -365, 'DD'), 'EXISTING', 'NEW')"/>
    <TRANSFORMFIELD NAME="FULL_ADDRESS" EXPR="TRIM(ADDRESS) || ', ' || TRIM(CITY) || ', ' || TRIM(STATE) || ' ' || ZIP_CODE_PADDED"/>
    <TRANSFORMFIELD NAME="STANDARDIZED_EMAIL" EXPR="LOWER(TRIM(EMAIL_UPPER))"/>
    <TRANSFORMFIELD NAME="STANDARDIZED_PHONE" EXPR="'1-' || SUBSTR(PHONE_CLEAN, 1, 3) || '-' || SUBSTR(PHONE_CLEAN, 4, 3) || '-' || SUBSTR(PHONE_CLEAN, 7)"/>
  </TRANSFORMATION>
  
  <!-- Joiner: Enrich with customer history (optional) -->
  <TRANSFORMATION NAME="JNR_CUSTOMER_HISTORY" TYPE="Joiner">
    <JOINCONDITION LEFTFIELD="CUSTOMER_ID" RIGHTFIELD="CUSTOMER_ID" JOINTYPE="LEFT"/>
  </TRANSFORMATION>
  
  <!-- Aggregator: Deduplicate customers -->
  <TRANSFORMATION NAME="AGG_DEDUPE" TYPE="Aggregator">
    <TRANSFORMFIELD NAME="MAX_UPDATED_DATE" EXPR="MAX(UPDATED_DATE)"/>
    <GROUPBYFIELD NAME="CUSTOMER_KEY"/>
    <GROUPBYFIELD NAME="EMAIL_UPPER"/>
  </TRANSFORMATION>
  
  <!-- Rank: Get latest record per customer -->
  <TRANSFORMATION NAME="RNK_LATEST" TYPE="Rank">
    <RANKFIELD NAME="UPDATED_DATE" DIRECTION="DESC"/>
    <RANKKEY NAME="CUSTOMER_KEY"/>
    <RANKLIMIT VALUE="1"/>
  </TRANSFORMATION>
  
  <!-- Sorter: Sort by customer key for performance -->
  <TRANSFORMATION NAME="SRT_BY_KEY" TYPE="Sorter">
    <SORTKEY NAME="CUSTOMER_KEY" DIRECTION="ASC"/>
  </TRANSFORMATION>
  
  <!-- Target: Standardized customer table -->
  <TARGET NAME="STD_CUSTOMERS" TYPE="Target">
    <TABLE NAME="STD_CUSTOMERS" DATABASENAME="STANDARDIZATION_DB"/>
  </TARGET>
  
  <!-- Connectors -->
  <CONNECTOR FROMINSTANCE="SQ_STAGE_CUSTOMERS" FROMFIELD="*" TOINSTANCE="LK_REGION" TOFIELD="*"/>
  <CONNECTOR FROMINSTANCE="LK_REGION" FROMFIELD="STATE" TOINSTANCE="EXP_ENRICH" TOFIELD="STATE"/>
  <CONNECTOR FROMINSTANCE="LK_REGION" FROMFIELD="REGION_CODE" TOINSTANCE="EXP_ENRICH" TOFIELD="REGION_CODE"/>
  <CONNECTOR FROMINSTANCE="LK_REGION" FROMFIELD="REGION_NAME" TOINSTANCE="EXP_ENRICH" TOFIELD="REGION_NAME"/>
  <CONNECTOR FROMINSTANCE="SQ_STAGE_CUSTOMERS" FROMFIELD="*" TOINSTANCE="EXP_ENRICH" TOFIELD="*"/>
  <CONNECTOR FROMINSTANCE="EXP_ENRICH" FROMFIELD="*" TOINSTANCE="AGG_DEDUPE" TOFIELD="*"/>
  <CONNECTOR FROMINSTANCE="AGG_DEDUPE" FROMFIELD="*" TOINSTANCE="RNK_LATEST" TOFIELD="*"/>
  <CONNECTOR FROMINSTANCE="RNK_LATEST" FROMFIELD="*" TOINSTANCE="SRT_BY_KEY" TOFIELD="*"/>
  <CONNECTOR FROMINSTANCE="SRT_BY_KEY" FROMFIELD="*" TOINSTANCE="STD_CUSTOMERS" TOFIELD="*"/>
  
</MAPPING>

