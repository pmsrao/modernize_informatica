<?xml version="1.0"?>
<WORKFLOW NAME="WF_ENTERPRISE_ETL_PIPELINE">
  <!-- Initial data load sessions -->
  <TASKINSTANCE NAME="S_M_LOAD_CUSTOMERS" TASKTYPE="Session" WORKLETNAME="">
    <ATTRIBUTE NAME="Enabled" VALUE="YES"/>
  </TASKINSTANCE>
  <TASKINSTANCE NAME="S_M_LOAD_PRODUCTS" TASKTYPE="Session"/>
  <TASKINSTANCE NAME="S_M_LOAD_ORDERS" TASKTYPE="Session"/>

  <!-- Dimension build worklet with nested structure -->
  <TASKINSTANCE NAME="WK_DIMENSIONS_BUILD" TASKTYPE="Worklet" WORKLETNAME="WK_BUILD_ALL_DIMENSIONS"/>

  <!-- Fact table processing worklet -->
  <TASKINSTANCE NAME="WK_FACT_PROCESSING" TASKTYPE="Worklet" WORKLETNAME="WK_PROCESS_FACTS"/>

  <!-- Aggregation and reporting sessions -->
  <TASKINSTANCE NAME="S_M_AGGREGATE_SALES" TASKTYPE="Session"/>
  <TASKINSTANCE NAME="S_M_AGGREGATE_INVENTORY" TASKTYPE="Session"/>

  <!-- Data quality validation -->
  <TASKINSTANCE NAME="S_M_DATA_QUALITY_CHECK" TASKTYPE="Session"/>

  <!-- Final reconciliation -->
  <TASKINSTANCE NAME="S_M_RECONCILE_TOTALS" TASKTYPE="Session"/>

  <!-- Parallel execution: Load all source tables simultaneously -->
  <CONNECTOR FROMINSTANCE="S_M_LOAD_CUSTOMERS" FROMLINK="Success" TOINSTANCE="WK_DIMENSIONS_BUILD" TOLINK="Start"/>
  <CONNECTOR FROMINSTANCE="S_M_LOAD_PRODUCTS" FROMLINK="Success" TOINSTANCE="WK_DIMENSIONS_BUILD" TOLINK="Start"/>
  <CONNECTOR FROMINSTANCE="S_M_LOAD_ORDERS" FROMLINK="Success" TOINSTANCE="WK_FACT_PROCESSING" TOLINK="Start"/>

  <!-- Sequential: Dimensions must complete before facts -->
  <CONNECTOR FROMINSTANCE="WK_DIMENSIONS_BUILD" FROMLINK="Success" TOINSTANCE="WK_FACT_PROCESSING" TOLINK="Start"/>

  <!-- Parallel aggregation after fact processing -->
  <CONNECTOR FROMINSTANCE="WK_FACT_PROCESSING" FROMLINK="Success" TOINSTANCE="S_M_AGGREGATE_SALES" TOLINK="Start"/>
  <CONNECTOR FROMINSTANCE="WK_FACT_PROCESSING" FROMLINK="Success" TOINSTANCE="S_M_AGGREGATE_INVENTORY" TOLINK="Start"/>

  <!-- Data quality depends on both aggregations -->
  <CONNECTOR FROMINSTANCE="S_M_AGGREGATE_SALES" FROMLINK="Success" TOINSTANCE="S_M_DATA_QUALITY_CHECK" TOLINK="Start"/>
  <CONNECTOR FROMINSTANCE="S_M_AGGREGATE_INVENTORY" FROMLINK="Success" TOINSTANCE="S_M_DATA_QUALITY_CHECK" TOLINK="Start"/>

  <!-- Final reconciliation after quality check -->
  <CONNECTOR FROMINSTANCE="S_M_DATA_QUALITY_CHECK" FROMLINK="Success" TOINSTANCE="S_M_RECONCILE_TOTALS" TOLINK="Start"/>

  <!-- Error handling paths -->
  <CONNECTOR FROMINSTANCE="S_M_LOAD_CUSTOMERS" FROMLINK="Failed" TOINSTANCE="S_M_RECONCILE_TOTALS" TOLINK="Start"/>
  <CONNECTOR FROMINSTANCE="WK_DIMENSIONS_BUILD" FROMLINK="Failed" TOINSTANCE="S_M_RECONCILE_TOTALS" TOLINK="Start"/>
</WORKFLOW>
