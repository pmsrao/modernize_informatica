<?xml version="1.0"?>
<MAPPING NAME="M_COMPLEX_SALES_ANALYTICS">
  <!-- Multiple source qualifiers -->
  <TRANSFORMATION NAME="SQ_CUSTOMERS" TYPE="SourceQualifier">
    <ATTRIBUTE NAME="Sql Query" VALUE="SELECT CUSTOMER_ID, FIRST_NAME, LAST_NAME, EMAIL, REGION_ID, CREATED_DATE, STATUS FROM CUSTOMER_SRC WHERE STATUS = 'ACTIVE'"/>
  </TRANSFORMATION>

  <TRANSFORMATION NAME="SQ_ORDERS" TYPE="SourceQualifier">
    <ATTRIBUTE NAME="Sql Query" VALUE="SELECT ORDER_ID, CUSTOMER_ID, PRODUCT_ID, ORDER_DATE, QUANTITY, UNIT_PRICE, DISCOUNT_PCT, SHIPPING_COST FROM ORDER_SRC WHERE ORDER_DATE >= TO_DATE('2020-01-01', 'YYYY-MM-DD')"/>
  </TRANSFORMATION>

  <TRANSFORMATION NAME="SQ_PRODUCTS" TYPE="SourceQualifier">
    <ATTRIBUTE NAME="Sql Query" VALUE="SELECT PRODUCT_ID, PRODUCT_NAME, CATEGORY_ID, SUPPLIER_ID, COST_PRICE, LIST_PRICE FROM PRODUCT_SRC"/>
  </TRANSFORMATION>

  <!-- Complex expression transformation with nested logic -->
  <TRANSFORMATION NAME="EXP_CUSTOMER_ENRICH" TYPE="Expression">
    <TRANSFORMFIELD NAME="FULL_NAME" EXPR="UPPER(TRIM(FIRST_NAME) || ' ' || TRIM(LAST_NAME))"/>
    <TRANSFORMFIELD NAME="EMAIL_DOMAIN" EXPR="SUBSTR(EMAIL, INSTR(EMAIL, '@') + 1)"/>
    <TRANSFORMFIELD NAME="CUSTOMER_SEGMENT" EXPR="IIF(REGION_ID IN (1, 2, 3), 'PREMIUM', IIF(REGION_ID IN (4, 5), 'STANDARD', 'BASIC'))"/>
    <TRANSFORMFIELD NAME="CUSTOMER_AGE_DAYS" EXPR="TO_DATE(SYSDATE) - TO_DATE(CREATED_DATE)"/>
    <TRANSFORMFIELD NAME="IS_VALID_EMAIL" EXPR="IIF(INSTR(EMAIL, '@') > 0 AND INSTR(EMAIL, '.') > INSTR(EMAIL, '@'), 1, 0)"/>
  </TRANSFORMATION>

  <!-- Expression for order calculations -->
  <TRANSFORMATION NAME="EXP_ORDER_CALC" TYPE="Expression">
    <TRANSFORMFIELD NAME="LINE_TOTAL" EXPR="QUANTITY * UNIT_PRICE"/>
    <TRANSFORMFIELD NAME="DISCOUNT_AMT" EXPR="LINE_TOTAL * (DISCOUNT_PCT / 100)"/>
    <TRANSFORMFIELD NAME="NET_AMOUNT" EXPR="LINE_TOTAL - DISCOUNT_AMT"/>
    <TRANSFORMFIELD NAME="TOTAL_AMOUNT" EXPR="NET_AMOUNT + SHIPPING_COST"/>
    <TRANSFORMFIELD NAME="ORDER_YEAR" EXPR="TO_CHAR(ORDER_DATE, 'YYYY')"/>
    <TRANSFORMFIELD NAME="ORDER_QUARTER" EXPR="TO_CHAR(ORDER_DATE, 'Q')"/>
    <TRANSFORMFIELD NAME="ORDER_MONTH" EXPR="TO_CHAR(ORDER_DATE, 'MM')"/>
    <TRANSFORMFIELD NAME="IS_LARGE_ORDER" EXPR="IIF(TOTAL_AMOUNT > 1000, 1, 0)"/>
  </TRANSFORMATION>

  <!-- Multiple lookups -->
  <TRANSFORMATION NAME="LK_REGION" TYPE="Lookup">
    <LOOKUPTABLE NAME="REGION_DIM"/>
    <LOOKUPFIELD NAME="REGION_ID" EXPR="REGION_ID"/>
    <RETURNFIELD NAME="REGION_NAME"/>
    <RETURNFIELD NAME="REGION_MANAGER"/>
    <RETURNFIELD NAME="SALES_TARGET"/>
  </TRANSFORMATION>

  <TRANSFORMATION NAME="LK_PRODUCT_CATEGORY" TYPE="Lookup">
    <LOOKUPTABLE NAME="CATEGORY_DIM"/>
    <LOOKUPFIELD NAME="CATEGORY_ID" EXPR="CATEGORY_ID"/>
    <RETURNFIELD NAME="CATEGORY_NAME"/>
    <RETURNFIELD NAME="CATEGORY_HIERARCHY"/>
  </TRANSFORMATION>

  <TRANSFORMATION NAME="LK_SUPPLIER" TYPE="Lookup">
    <LOOKUPTABLE NAME="SUPPLIER_DIM"/>
    <LOOKUPFIELD NAME="SUPPLIER_ID" EXPR="SUPPLIER_ID"/>
    <RETURNFIELD NAME="SUPPLIER_NAME"/>
    <RETURNFIELD NAME="SUPPLIER_RATING"/>
  </TRANSFORMATION>

  <!-- Joiner transformation for complex joins -->
  <TRANSFORMATION NAME="JNR_CUSTOMER_ORDER" TYPE="Joiner">
    <JOINCONDITION LEFTFIELD="CUSTOMER_ID" RIGHTFIELD="CUSTOMER_ID" JOINTYPE="INNER"/>
  </TRANSFORMATION>

  <!-- Router for data splitting -->
  <TRANSFORMATION NAME="RTR_ORDER_ROUTING" TYPE="Router">
    <GROUP NAME="HIGH_VALUE" CONDITION="TOTAL_AMOUNT >= 5000"/>
    <GROUP NAME="MEDIUM_VALUE" CONDITION="TOTAL_AMOUNT >= 1000 AND TOTAL_AMOUNT < 5000"/>
    <GROUP NAME="LOW_VALUE" CONDITION="TOTAL_AMOUNT < 1000"/>
  </TRANSFORMATION>

  <!-- Aggregator with complex grouping -->
  <TRANSFORMATION NAME="AGG_SALES_BY_CUSTOMER" TYPE="Aggregator">
    <TRANSFORMFIELD NAME="TOTAL_SALES" EXPR="SUM(TOTAL_AMOUNT)"/>
    <TRANSFORMFIELD NAME="ORDER_COUNT" EXPR="COUNT(ORDER_ID)"/>
    <TRANSFORMFIELD NAME="AVG_ORDER_VALUE" EXPR="AVG(TOTAL_AMOUNT)"/>
    <TRANSFORMFIELD NAME="MAX_ORDER_VALUE" EXPR="MAX(TOTAL_AMOUNT)"/>
    <TRANSFORMFIELD NAME="MIN_ORDER_VALUE" EXPR="MIN(TOTAL_AMOUNT)"/>
    <GROUPBYFIELD NAME="CUSTOMER_ID"/>
    <GROUPBYFIELD NAME="REGION_NAME"/>
    <GROUPBYFIELD NAME="ORDER_YEAR"/>
    <GROUPBYFIELD NAME="ORDER_QUARTER"/>
  </TRANSFORMATION>

  <!-- Second aggregator for product analysis -->
  <TRANSFORMATION NAME="AGG_PRODUCT_PERFORMANCE" TYPE="Aggregator">
    <TRANSFORMFIELD NAME="TOTAL_REVENUE" EXPR="SUM(TOTAL_AMOUNT)"/>
    <TRANSFORMFIELD NAME="TOTAL_QUANTITY" EXPR="SUM(QUANTITY)"/>
    <TRANSFORMFIELD NAME="TOTAL_DISCOUNT" EXPR="SUM(DISCOUNT_AMT)"/>
    <TRANSFORMFIELD NAME="UNIQUE_CUSTOMERS" EXPR="COUNT(DISTINCT CUSTOMER_ID)"/>
    <GROUPBYFIELD NAME="PRODUCT_ID"/>
    <GROUPBYFIELD NAME="CATEGORY_NAME"/>
    <GROUPBYFIELD NAME="ORDER_MONTH"/>
  </TRANSFORMATION>

  <!-- Rank transformation for top N analysis -->
  <TRANSFORMATION NAME="RNK_TOP_CUSTOMERS" TYPE="Rank">
    <RANKFIELD NAME="TOTAL_SALES" DIRECTION="DESC"/>
    <RANKKEY NAME="CUSTOMER_ID"/>
    <RANKLIMIT VALUE="100"/>
  </TRANSFORMATION>

  <!-- Filter transformation -->
  <TRANSFORMATION NAME="FLT_VALID_RECORDS" TYPE="Filter">
    <FILTERCONDITION EXPR="IS_VALID_EMAIL = 1 AND TOTAL_AMOUNT > 0 AND REGION_NAME IS NOT NULL"/>
  </TRANSFORMATION>

  <!-- Update strategy for SCD2 -->
  <TRANSFORMATION NAME="UPD_STRATEGY" TYPE="UpdateStrategy">
    <ATTRIBUTE NAME="Update Strategy Expression" VALUE="IIF(ISNULL(EFFECTIVE_FROM), DD_INSERT, DD_UPDATE)"/>
  </TRANSFORMATION>

  <!-- Target tables -->
  <TARGET NAME="TGT_SALES_FACT" TYPE="Table">
    <ATTRIBUTE NAME="Table Name" VALUE="SALES_FACT"/>
  </TARGET>

  <TARGET NAME="TGT_CUSTOMER_DIM" TYPE="Table">
    <ATTRIBUTE NAME="Table Name" VALUE="CUSTOMER_DIM_SCD2"/>
  </TARGET>

  <TARGET NAME="TGT_PRODUCT_SUMMARY" TYPE="Table">
    <ATTRIBUTE NAME="Table Name" VALUE="PRODUCT_PERFORMANCE_SUMMARY"/>
  </TARGET>

  <!-- Complex connector flow -->
  <CONNECTOR FROMINSTANCE="SQ_CUSTOMERS" FROMFIELD="*" TOINSTANCE="EXP_CUSTOMER_ENRICH" TOFIELD="*"/>
  <CONNECTOR FROMINSTANCE="EXP_CUSTOMER_ENRICH" FROMFIELD="REGION_ID" TOINSTANCE="LK_REGION" TOFIELD="REGION_ID"/>
  <CONNECTOR FROMINSTANCE="LK_REGION" FROMFIELD="*" TOINSTANCE="JNR_CUSTOMER_ORDER" TOFIELD="*"/>
  <CONNECTOR FROMINSTANCE="SQ_ORDERS" FROMFIELD="*" TOINSTANCE="EXP_ORDER_CALC" TOFIELD="*"/>
  <CONNECTOR FROMINSTANCE="EXP_ORDER_CALC" FROMFIELD="*" TOINSTANCE="JNR_CUSTOMER_ORDER" TOFIELD="*"/>
  <CONNECTOR FROMINSTANCE="JNR_CUSTOMER_ORDER" FROMFIELD="PRODUCT_ID" TOINSTANCE="SQ_PRODUCTS" TOFIELD="PRODUCT_ID"/>
  <CONNECTOR FROMINSTANCE="SQ_PRODUCTS" FROMFIELD="CATEGORY_ID" TOINSTANCE="LK_PRODUCT_CATEGORY" TOFIELD="CATEGORY_ID"/>
  <CONNECTOR FROMINSTANCE="SQ_PRODUCTS" FROMFIELD="SUPPLIER_ID" TOINSTANCE="LK_SUPPLIER" TOFIELD="SUPPLIER_ID"/>
  <CONNECTOR FROMINSTANCE="LK_PRODUCT_CATEGORY" FROMFIELD="*" TOINSTANCE="RTR_ORDER_ROUTING" TOFIELD="*"/>
  <CONNECTOR FROMINSTANCE="LK_SUPPLIER" FROMFIELD="*" TOINSTANCE="RTR_ORDER_ROUTING" TOFIELD="*"/>
  <CONNECTOR FROMINSTANCE="RTR_ORDER_ROUTING" FROMFIELD="HIGH_VALUE.*" TOINSTANCE="AGG_SALES_BY_CUSTOMER" TOFIELD="*"/>
  <CONNECTOR FROMINSTANCE="RTR_ORDER_ROUTING" FROMFIELD="MEDIUM_VALUE.*" TOINSTANCE="AGG_SALES_BY_CUSTOMER" TOFIELD="*"/>
  <CONNECTOR FROMINSTANCE="AGG_SALES_BY_CUSTOMER" FROMFIELD="*" TOINSTANCE="RNK_TOP_CUSTOMERS" TOFIELD="*"/>
  <CONNECTOR FROMINSTANCE="RNK_TOP_CUSTOMERS" FROMFIELD="*" TOINSTANCE="FLT_VALID_RECORDS" TOFIELD="*"/>
  <CONNECTOR FROMINSTANCE="FLT_VALID_RECORDS" FROMFIELD="*" TOINSTANCE="UPD_STRATEGY" TOFIELD="*"/>
  <CONNECTOR FROMINSTANCE="UPD_STRATEGY" FROMFIELD="*" TOINSTANCE="TGT_SALES_FACT" TOFIELD="*"/>
  <CONNECTOR FROMINSTANCE="EXP_CUSTOMER_ENRICH" FROMFIELD="*" TOINSTANCE="TGT_CUSTOMER_DIM" TOFIELD="*"/>
  <CONNECTOR FROMINSTANCE="RTR_ORDER_ROUTING" FROMFIELD="*" TOINSTANCE="AGG_PRODUCT_PERFORMANCE" TOFIELD="*"/>
  <CONNECTOR FROMINSTANCE="AGG_PRODUCT_PERFORMANCE" FROMFIELD="*" TOINSTANCE="TGT_PRODUCT_SUMMARY" TOFIELD="*"/>
</MAPPING>
