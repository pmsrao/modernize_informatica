<?xml version="1.0"?>
<MAPPING NAME="M_LOAD_ORDER_FACT">
  <!-- Mapping: Load Order Fact table
       Dimensional Layer: Fact table with multiple dimension lookups -->
  
  <!-- Source Qualifier: Read standardized orders -->
  <TRANSFORMATION NAME="SQ_STD_ORDERS" TYPE="SourceQualifier">
    <ATTRIBUTE NAME="Sql Query" VALUE="SELECT * FROM STD_ORDERS"/>
  </TRANSFORMATION>
  
  <!-- Lookups: Get dimension surrogate keys -->
  <TRANSFORMATION NAME="LK_CUSTOMER_DIM" TYPE="Lookup">
    <LOOKUPTABLE NAME="DIM_CUSTOMER"/>
    <LOOKUPFIELD NAME="CUSTOMER_KEY" EXPR="CUSTOMER_KEY"/>
    <RETURNFIELD NAME="CUSTOMER_SK"/>
  </TRANSFORMATION>
  
  <TRANSFORMATION NAME="LK_PRODUCT_DIM" TYPE="Lookup">
    <LOOKUPTABLE NAME="DIM_PRODUCT"/>
    <LOOKUPFIELD NAME="PRODUCT_KEY" EXPR="PRODUCT_KEY"/>
    <RETURNFIELD NAME="PRODUCT_SK"/>
  </TRANSFORMATION>
  
  <TRANSFORMATION NAME="LK_DATE_DIM" TYPE="Lookup">
    <LOOKUPTABLE NAME="DIM_DATE"/>
    <LOOKUPFIELD NAME="DATE_VALUE" EXPR="TRUNC(ORDER_DATE)"/>
    <RETURNFIELD NAME="DATE_SK"/>
  </TRANSFORMATION>
  
  <TRANSFORMATION NAME="LK_REGION_DIM" TYPE="Lookup">
    <LOOKUPTABLE NAME="DIM_REGION"/>
    <LOOKUPFIELD NAME="REGION_CODE" EXPR="REGION_CODE"/>
    <RETURNFIELD NAME="REGION_SK"/>
  </TRANSFORMATION>
  
  <!-- Expression: Prepare fact measures -->
  <TRANSFORMATION NAME="EXP_FACT_MEASURES" TYPE="Expression">
    <TRANSFORMFIELD NAME="ORDER_AMOUNT" EXPR="TOTAL_AMOUNT"/>
    <TRANSFORMFIELD NAME="DISCOUNT_AMOUNT" EXPR="TOTAL_DISCOUNT"/>
    <TRANSFORMFIELD NAME="SHIPPING_COST" EXPR="SHIPPING_COST"/>
    <TRANSFORMFIELD NAME="TAX_AMOUNT" EXPR="TAX_AMOUNT"/>
    <TRANSFORMFIELD NAME="NET_AMOUNT" EXPR="TOTAL_AMOUNT - TOTAL_DISCOUNT + SHIPPING_COST + TAX_AMOUNT"/>
    <TRANSFORMFIELD NAME="ORDER_QUANTITY" EXPR="TOTAL_QUANTITY"/>
    <TRANSFORMFIELD NAME="ORDER_LINES" EXPR="TOTAL_LINES"/>
  </TRANSFORMATION>
  
  <!-- Joiner: Combine all dimension lookups -->
  <TRANSFORMATION NAME="JNR_DIMENSIONS" TYPE="Joiner">
    <JOINCONDITION LEFTFIELD="ORDER_ID" RIGHTFIELD="ORDER_ID" JOINTYPE="INNER"/>
  </TRANSFORMATION>
  
  <!-- Aggregator: Aggregate by dimension keys (if needed) -->
  <TRANSFORMATION NAME="AGG_FACT_AGGREGATION" TYPE="Aggregator">
    <TRANSFORMFIELD NAME="TOTAL_ORDER_AMOUNT" EXPR="SUM(ORDER_AMOUNT)"/>
    <TRANSFORMFIELD NAME="TOTAL_DISCOUNT" EXPR="SUM(DISCOUNT_AMOUNT)"/>
    <TRANSFORMFIELD NAME="TOTAL_QUANTITY" EXPR="SUM(ORDER_QUANTITY)"/>
    <TRANSFORMFIELD NAME="ORDER_COUNT" EXPR="COUNT(DISTINCT ORDER_ID)"/>
    <GROUPBYFIELD NAME="CUSTOMER_SK"/>
    <GROUPBYFIELD NAME="PRODUCT_SK"/>
    <GROUPBYFIELD NAME="DATE_SK"/>
    <GROUPBYFIELD NAME="REGION_SK"/>
  </TRANSFORMATION>
  
  <!-- Update Strategy: Handle inserts -->
  <TRANSFORMATION NAME="UPD_STRATEGY" TYPE="UpdateStrategy">
    <ATTRIBUTE NAME="Update Strategy Expression" VALUE="DD_INSERT"/>
  </TRANSFORMATION>
  
  <!-- Target: Order Fact table -->
  <TARGET NAME="FACT_ORDERS" TYPE="Target">
    <TABLE NAME="FACT_ORDERS" DATABASENAME="DIMENSIONAL_DB"/>
  </TARGET>
  
  <!-- Connectors -->
  <CONNECTOR FROMINSTANCE="SQ_STD_ORDERS" FROMFIELD="CUSTOMER_KEY" TOINSTANCE="LK_CUSTOMER_DIM" TOFIELD="CUSTOMER_KEY"/>
  <CONNECTOR FROMINSTANCE="SQ_STD_ORDERS" FROMFIELD="PRODUCT_KEY" TOINSTANCE="LK_PRODUCT_DIM" TOFIELD="PRODUCT_KEY"/>
  <CONNECTOR FROMINSTANCE="SQ_STD_ORDERS" FROMFIELD="ORDER_DATE" TOINSTANCE="LK_DATE_DIM" TOFIELD="DATE_VALUE"/>
  <CONNECTOR FROMINSTANCE="SQ_STD_ORDERS" FROMFIELD="REGION_CODE" TOINSTANCE="LK_REGION_DIM" TOFIELD="REGION_CODE"/>
  <CONNECTOR FROMINSTANCE="SQ_STD_ORDERS" FROMFIELD="*" TOINSTANCE="EXP_FACT_MEASURES" TOFIELD="*"/>
  <CONNECTOR FROMINSTANCE="LK_CUSTOMER_DIM" FROMFIELD="CUSTOMER_SK" TOINSTANCE="EXP_FACT_MEASURES" TOFIELD="CUSTOMER_SK"/>
  <CONNECTOR FROMINSTANCE="LK_PRODUCT_DIM" FROMFIELD="PRODUCT_SK" TOINSTANCE="EXP_FACT_MEASURES" TOFIELD="PRODUCT_SK"/>
  <CONNECTOR FROMINSTANCE="LK_DATE_DIM" FROMFIELD="DATE_SK" TOINSTANCE="EXP_FACT_MEASURES" TOFIELD="DATE_SK"/>
  <CONNECTOR FROMINSTANCE="LK_REGION_DIM" FROMFIELD="REGION_SK" TOINSTANCE="EXP_FACT_MEASURES" TOFIELD="REGION_SK"/>
  <CONNECTOR FROMINSTANCE="EXP_FACT_MEASURES" FROMFIELD="*" TOINSTANCE="AGG_FACT_AGGREGATION" TOFIELD="*"/>
  <CONNECTOR FROMINSTANCE="AGG_FACT_AGGREGATION" FROMFIELD="*" TOINSTANCE="UPD_STRATEGY" TOFIELD="*"/>
  <CONNECTOR FROMINSTANCE="UPD_STRATEGY" FROMFIELD="*" TOINSTANCE="FACT_ORDERS" TOFIELD="*"/>
  
</MAPPING>

