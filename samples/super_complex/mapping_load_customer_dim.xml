<?xml version="1.0"?>
<MAPPING NAME="M_LOAD_CUSTOMER_DIM">
  <!-- Mapping: Load Customer Dimension (SCD Type 2)
       Dimensional Layer: Slowly Changing Dimension handling -->
  
  <!-- Source Qualifier: Read standardized customers -->
  <TRANSFORMATION NAME="SQ_STD_CUSTOMERS" TYPE="SourceQualifier">
    <ATTRIBUTE NAME="Sql Query" VALUE="SELECT * FROM STD_CUSTOMERS"/>
  </TRANSFORMATION>
  
  <!-- Lookup: Check existing dimension records -->
  <TRANSFORMATION NAME="LK_DIM_CUSTOMER" TYPE="Lookup">
    <LOOKUPTABLE NAME="DIM_CUSTOMER"/>
    <LOOKUPFIELD NAME="CUSTOMER_KEY" EXPR="CUSTOMER_KEY"/>
    <RETURNFIELD NAME="CUSTOMER_SK"/>
    <RETURNFIELD NAME="CURRENT_FLAG"/>
    <RETURNFIELD NAME="EFFECTIVE_DATE"/>
    <RETURNFIELD NAME="EXPIRY_DATE"/>
  </TRANSFORMATION>
  
  <!-- Expression: SCD Type 2 logic -->
  <TRANSFORMATION NAME="EXP_SCD_LOGIC" TYPE="Expression">
    <TRANSFORMFIELD NAME="IS_NEW" EXPR="IIF(ISNULL(CUSTOMER_SK), 1, 0)"/>
    <TRANSFORMFIELD NAME="HAS_CHANGED" EXPR="IIF(NOT ISNULL(CUSTOMER_SK) AND (EMAIL_UPPER != LK_EMAIL OR PHONE_CLEAN != LK_PHONE), 1, 0)"/>
    <TRANSFORMFIELD NAME="SCD_FLAG" EXPR="IIF(IS_NEW = 1, 'INSERT', IIF(HAS_CHANGED = 1, 'UPDATE', 'NO_CHANGE'))"/>
    <TRANSFORMFIELD NAME="EFFECTIVE_DATE" EXPR="SYSDATE"/>
    <TRANSFORMFIELD NAME="EXPIRY_DATE" EXPR="TO_DATE('9999-12-31', 'YYYY-MM-DD')"/>
    <TRANSFORMFIELD NAME="CURRENT_FLAG" EXPR="'Y'"/>
  </TRANSFORMATION>
  
  <!-- Router: Split by SCD operation -->
  <TRANSFORMATION NAME="RTR_SCD_OPERATIONS" TYPE="Router">
    <GROUP NAME="NEW_RECORDS" CONDITION="SCD_FLAG = 'INSERT'"/>
    <GROUP NAME="CHANGED_RECORDS" CONDITION="SCD_FLAG = 'UPDATE'"/>
    <GROUP NAME="UNCHANGED" CONDITION="SCD_FLAG = 'NO_CHANGE'"/>
  </TRANSFORMATION>
  
  <!-- Expression: Expire old records -->
  <TRANSFORMATION NAME="EXP_EXPIRE_OLD" TYPE="Expression">
    <TRANSFORMFIELD NAME="CURRENT_FLAG" EXPR="'N'"/>
    <TRANSFORMFIELD NAME="EXPIRY_DATE" EXPR="SYSDATE - 1"/>
  </TRANSFORMATION>
  
  <!-- Update Strategy: Handle inserts and updates -->
  <TRANSFORMATION NAME="UPD_NEW_RECORDS" TYPE="UpdateStrategy">
    <ATTRIBUTE NAME="Update Strategy Expression" VALUE="DD_INSERT"/>
  </TRANSFORMATION>
  
  <TRANSFORMATION NAME="UPD_EXPIRE_OLD" TYPE="UpdateStrategy">
    <ATTRIBUTE NAME="Update Strategy Expression" VALUE="DD_UPDATE"/>
  </TRANSFORMATION>
  
  <!-- Target: Customer Dimension -->
  <TARGET NAME="DIM_CUSTOMER" TYPE="Target">
    <TABLE NAME="DIM_CUSTOMER" DATABASENAME="DIMENSIONAL_DB"/>
  </TARGET>
  
  <!-- Connectors -->
  <CONNECTOR FROMINSTANCE="SQ_STD_CUSTOMERS" FROMFIELD="*" TOINSTANCE="LK_DIM_CUSTOMER" TOFIELD="*"/>
  <CONNECTOR FROMINSTANCE="LK_DIM_CUSTOMER" FROMFIELD="*" TOINSTANCE="EXP_SCD_LOGIC" TOFIELD="*"/>
  <CONNECTOR FROMINSTANCE="SQ_STD_CUSTOMERS" FROMFIELD="*" TOINSTANCE="EXP_SCD_LOGIC" TOFIELD="*"/>
  <CONNECTOR FROMINSTANCE="EXP_SCD_LOGIC" FROMFIELD="*" TOINSTANCE="RTR_SCD_OPERATIONS" TOFIELD="*"/>
  <CONNECTOR FROMINSTANCE="RTR_SCD_OPERATIONS" FROMFIELD="NEW_RECORDS.*" TOINSTANCE="UPD_NEW_RECORDS" TOFIELD="*"/>
  <CONNECTOR FROMINSTANCE="RTR_SCD_OPERATIONS" FROMFIELD="CHANGED_RECORDS.*" TOINSTANCE="EXP_EXPIRE_OLD" TOFIELD="*"/>
  <CONNECTOR FROMINSTANCE="UPD_NEW_RECORDS" FROMFIELD="*" TOINSTANCE="DIM_CUSTOMER" TOFIELD="*"/>
  <CONNECTOR FROMINSTANCE="EXP_EXPIRE_OLD" FROMFIELD="*" TOINSTANCE="UPD_EXPIRE_OLD" TOFIELD="*"/>
  <CONNECTOR FROMINSTANCE="UPD_EXPIRE_OLD" FROMFIELD="*" TOINSTANCE="DIM_CUSTOMER" TOFIELD="*"/>
  
</MAPPING>

