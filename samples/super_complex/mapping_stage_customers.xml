<?xml version="1.0"?>
<MAPPING NAME="M_STAGE_CUSTOMERS">
  <!-- Mapping: Stage customer data with data quality checks
       Staging Layer: Raw data with basic validation -->
  
  <!-- Source Qualifier: Read from ingestion staging -->
  <TRANSFORMATION NAME="SQ_STG_CUSTOMERS" TYPE="SourceQualifier">
    <ATTRIBUTE NAME="Sql Query" VALUE="SELECT * FROM STG_CUSTOMERS WHERE INGESTION_TIMESTAMP >= TO_DATE('2024-01-01', 'YYYY-MM-DD')"/>
  </TRANSFORMATION>
  
  <!-- Expression: Data validation and standardization -->
  <TRANSFORMATION NAME="EXP_VALIDATE" TYPE="Expression">
    <TRANSFORMFIELD NAME="FULL_NAME" EXPR="TRIM(FIRST_NAME) || ' ' || TRIM(LAST_NAME)"/>
    <TRANSFORMFIELD NAME="EMAIL_UPPER" EXPR="UPPER(TRIM(EMAIL))"/>
    <TRANSFORMFIELD NAME="PHONE_CLEAN" EXPR="REPLACE(REPLACE(REPLACE(PHONE, '-', ''), '(', ''), ')', '')"/>
    <TRANSFORMFIELD NAME="ZIP_CODE_PADDED" EXPR="LPAD(ZIP_CODE, 5, '0')"/>
    <TRANSFORMFIELD NAME="IS_VALID_EMAIL" EXPR="IIF(INSTR(EMAIL, '@') > 0 AND INSTR(EMAIL, '.') > INSTR(EMAIL, '@'), 1, 0)"/>
    <TRANSFORMFIELD NAME="IS_VALID_PHONE" EXPR="IIF(LENGTH(PHONE_CLEAN) >= 10, 1, 0)"/>
  </TRANSFORMATION>
  
  <!-- Filter: Only valid records -->
  <TRANSFORMATION NAME="FLT_VALID_RECORDS" TYPE="Filter">
    <ATTRIBUTE NAME="Filter Condition" VALUE="IS_VALID_EMAIL = 1 AND IS_VALID_PHONE = 1 AND STATUS = 'ACTIVE'"/>
  </TRANSFORMATION>
  
  <!-- Router: Split valid and invalid records -->
  <TRANSFORMATION NAME="RTR_DATA_QUALITY" TYPE="Router">
    <GROUP NAME="VALID" CONDITION="IS_VALID_EMAIL = 1 AND IS_VALID_PHONE = 1"/>
    <GROUP NAME="INVALID" CONDITION="IS_VALID_EMAIL = 0 OR IS_VALID_PHONE = 0"/>
  </TRANSFORMATION>
  
  <!-- Update Strategy: Handle inserts and updates -->
  <TRANSFORMATION NAME="UPD_STRATEGY" TYPE="UpdateStrategy">
    <ATTRIBUTE NAME="Update Strategy Expression" VALUE="IIF(DD_UPDATE = 'INSERT', DD_INSERT, DD_UPDATE)"/>
  </TRANSFORMATION>
  
  <!-- Target: Staging table -->
  <TARGET NAME="STAGE_CUSTOMERS" TYPE="Target">
    <TABLE NAME="STAGE_CUSTOMERS" DATABASENAME="STAGING_DB"/>
  </TARGET>
  
  <!-- Target: Reject table for invalid records -->
  <TARGET NAME="REJECT_CUSTOMERS" TYPE="Target">
    <TABLE NAME="REJECT_CUSTOMERS" DATABASENAME="STAGING_DB"/>
  </TARGET>
  
  <!-- Connectors -->
  <CONNECTOR FROMINSTANCE="SQ_STG_CUSTOMERS" FROMFIELD="*" TOINSTANCE="EXP_VALIDATE" TOFIELD="*"/>
  <CONNECTOR FROMINSTANCE="EXP_VALIDATE" FROMFIELD="*" TOINSTANCE="RTR_DATA_QUALITY" TOFIELD="*"/>
  <CONNECTOR FROMINSTANCE="RTR_DATA_QUALITY" FROMFIELD="VALID.*" TOINSTANCE="UPD_STRATEGY" TOFIELD="*"/>
  <CONNECTOR FROMINSTANCE="UPD_STRATEGY" FROMFIELD="*" TOINSTANCE="STAGE_CUSTOMERS" TOFIELD="*"/>
  <CONNECTOR FROMINSTANCE="RTR_DATA_QUALITY" FROMFIELD="INVALID.*" TOINSTANCE="REJECT_CUSTOMERS" TOFIELD="*"/>
  
</MAPPING>

