<?xml version="1.0"?>
<MAPPING NAME="M_STAGE_CUSTOMERS_ENHANCED">
  <!-- Mapping: Stage customer data with mapplet and reusable transformations
       Demonstrates: Mapplet instances, reusable transformations, custom transformations -->
  
  <!-- Source Qualifier -->
  <TRANSFORMATION NAME="SQ_STG_CUSTOMERS" TYPE="SourceQualifier">
    <ATTRIBUTE NAME="Sql Query" VALUE="SELECT * FROM STG_CUSTOMERS WHERE INGESTION_TIMESTAMP >= TO_DATE('2024-01-01', 'YYYY-MM-DD')"/>
  </TRANSFORMATION>
  
  <!-- Mapplet Instance: Data Cleansing -->
  <INSTANCE NAME="MPL_CLEANSE_INST" MAPPLETNAME="MPL_DATA_CLEANSING">
    <!-- Input port mappings -->
    <MAPPLETINPUTINSTANCE PORTNAME="RAW_ADDRESS" FROMINSTANCE="SQ_STG_CUSTOMERS" FROMFIELD="ADDRESS"/>
    <MAPPLETINPUTINSTANCE PORTNAME="RAW_PHONE" FROMINSTANCE="SQ_STG_CUSTOMERS" FROMFIELD="PHONE"/>
    <MAPPLETINPUTINSTANCE PORTNAME="RAW_EMAIL" FROMINSTANCE="SQ_STG_CUSTOMERS" FROMFIELD="EMAIL"/>
    <MAPPLETINPUTINSTANCE PORTNAME="RAW_ZIP_CODE" FROMINSTANCE="SQ_STG_CUSTOMERS" FROMFIELD="ZIP_CODE"/>
    <!-- Output port mappings -->
    <MAPPLETOUTPUTINSTANCE PORTNAME="CLEAN_ADDRESS" TOINSTANCE="EXP_CUSTOMER_ENRICH" TOFIELD="ADDRESS"/>
    <MAPPLETOUTPUTINSTANCE PORTNAME="CLEAN_EMAIL" TOINSTANCE="EXP_CUSTOMER_ENRICH" TOFIELD="EMAIL"/>
    <MAPPLETOUTPUTINSTANCE PORTNAME="PHONE_FORMATTED" TOINSTANCE="EXP_CUSTOMER_ENRICH" TOFIELD="PHONE"/>
    <MAPPLETOUTPUTINSTANCE PORTNAME="IS_VALID_ADDRESS" TOINSTANCE="FLT_VALID_RECORDS" TOFIELD="IS_VALID_ADDRESS"/>
    <MAPPLETOUTPUTINSTANCE PORTNAME="IS_VALID_EMAIL" TOINSTANCE="FLT_VALID_RECORDS" TOFIELD="IS_VALID_EMAIL"/>
    <MAPPLETOUTPUTINSTANCE PORTNAME="IS_VALID_PHONE" TOINSTANCE="FLT_VALID_RECORDS" TOFIELD="IS_VALID_PHONE"/>
  </INSTANCE>
  
  <!-- Reusable Expression Transformation: Customer Enrichment -->
  <TRANSFORMATION NAME="EXP_CUSTOMER_ENRICH" TYPE="Expression" REUSABLE="YES" REUSABLENAME="EXP_CUSTOMER_ENRICH">
    <TRANSFORMFIELD NAME="FULL_NAME" EXPR="TRIM(FIRST_NAME) || ' ' || TRIM(LAST_NAME)"/>
    <TRANSFORMFIELD NAME="CUSTOMER_TYPE" EXPR="IIF(REGISTRATION_DATE &lt; ADD_TO_DATE(SYSDATE, -365, 'DD'), 'LEGACY', 'NEW')"/>
    <TRANSFORMFIELD NAME="CUSTOMER_SEGMENT" EXPR="IIF(TOTAL_ORDERS > 10, 'PREMIUM', IIF(TOTAL_ORDERS > 5, 'REGULAR', 'BASIC'))"/>
  </TRANSFORMATION>
  
  <!-- Custom Transformation: Advanced Fraud Detection (requires manual intervention) -->
  <TRANSFORMATION NAME="CUSTOM_FRAUD_CHECK" TYPE="Custom">
    <ATTRIBUTE NAME="CustomCode" VALUE="com.company.fraud.FraudDetectionEngine"/>
    <ATTRIBUTE NAME="JavaClass" VALUE="FraudDetectionEngine"/>
  </TRANSFORMATION>
  
  <!-- Stored Procedure: Get Customer Credit Score (requires manual intervention) -->
  <TRANSFORMATION NAME="SP_GET_CREDIT_SCORE" TYPE="Stored Procedure">
    <ATTRIBUTE NAME="PROCEDURENAME" VALUE="GET_CUSTOMER_CREDIT_SCORE"/>
    <ATTRIBUTE NAME="CONNECTION" VALUE="CREDIT_DB_CONNECTION"/>
  </TRANSFORMATION>
  
  <!-- Filter: Only valid records -->
  <TRANSFORMATION NAME="FLT_VALID_RECORDS" TYPE="Filter">
    <ATTRIBUTE NAME="Filter Condition" VALUE="IS_VALID_EMAIL = 1 AND IS_VALID_PHONE = 1 AND IS_VALID_ADDRESS = 1"/>
  </TRANSFORMATION>
  
  <!-- Router: Split by customer segment -->
  <TRANSFORMATION NAME="RTR_BY_SEGMENT" TYPE="Router">
    <GROUP NAME="PREMIUM" CONDITION="CUSTOMER_SEGMENT = 'PREMIUM'"/>
    <GROUP NAME="REGULAR" CONDITION="CUSTOMER_SEGMENT = 'REGULAR'"/>
    <GROUP NAME="BASIC" CONDITION="CUSTOMER_SEGMENT = 'BASIC'"/>
  </TRANSFORMATION>
  
  <!-- Update Strategy -->
  <TRANSFORMATION NAME="UPD_STRATEGY" TYPE="UpdateStrategy">
    <ATTRIBUTE NAME="Update Strategy Expression" VALUE="IIF(DD_UPDATE = 'INSERT', DD_INSERT, DD_UPDATE)"/>
  </TRANSFORMATION>
  
  <!-- Targets -->
  <TARGET NAME="STAGE_CUSTOMERS" TYPE="Target">
    <TABLE NAME="STAGE_CUSTOMERS" DATABASENAME="STAGING_DB"/>
  </TARGET>
  
  <TARGET NAME="REJECT_CUSTOMERS" TYPE="Target">
    <TABLE NAME="REJECT_CUSTOMERS" DATABASENAME="STAGING_DB"/>
  </TARGET>
  
  <!-- Connectors -->
  <CONNECTOR FROMINSTANCE="SQ_STG_CUSTOMERS" FROMFIELD="*" TOINSTANCE="EXP_CUSTOMER_ENRICH" TOFIELD="*"/>
  <CONNECTOR FROMINSTANCE="EXP_CUSTOMER_ENRICH" FROMFIELD="*" TOINSTANCE="CUSTOM_FRAUD_CHECK" TOFIELD="*"/>
  <CONNECTOR FROMINSTANCE="CUSTOM_FRAUD_CHECK" FROMFIELD="*" TOINSTANCE="SP_GET_CREDIT_SCORE" TOFIELD="*"/>
  <CONNECTOR FROMINSTANCE="SP_GET_CREDIT_SCORE" FROMFIELD="*" TOINSTANCE="FLT_VALID_RECORDS" TOFIELD="*"/>
  <CONNECTOR FROMINSTANCE="FLT_VALID_RECORDS" FROMFIELD="*" TOINSTANCE="RTR_BY_SEGMENT" TOFIELD="*"/>
  <CONNECTOR FROMINSTANCE="RTR_BY_SEGMENT" FROMFIELD="PREMIUM.*" TOINSTANCE="UPD_STRATEGY" TOFIELD="*"/>
  <CONNECTOR FROMINSTANCE="RTR_BY_SEGMENT" FROMFIELD="REGULAR.*" TOINSTANCE="UPD_STRATEGY" TOFIELD="*"/>
  <CONNECTOR FROMINSTANCE="RTR_BY_SEGMENT" FROMFIELD="BASIC.*" TOINSTANCE="UPD_STRATEGY" TOFIELD="*"/>
  <CONNECTOR FROMINSTANCE="UPD_STRATEGY" FROMFIELD="*" TOINSTANCE="STAGE_CUSTOMERS" TOFIELD="*"/>
  <CONNECTOR FROMINSTANCE="RTR_BY_SEGMENT" FROMFIELD="INVALID.*" TOINSTANCE="REJECT_CUSTOMERS" TOFIELD="*"/>
  
</MAPPING>

