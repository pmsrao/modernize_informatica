<?xml version="1.0"?>
<MAPPLET NAME="MPL_DATA_CLEANSING">
  <!-- Mapplet: Reusable data cleansing transformations
       Purpose: Standard data cleansing logic for addresses, phones, emails
       Used in: Multiple staging mappings -->
  
  <!-- Input Ports: Raw data fields -->
  <INPUT NAME="RAW_ADDRESS" DATATYPE="string" PRECISION="200"/>
  <INPUT NAME="RAW_PHONE" DATATYPE="string" PRECISION="20"/>
  <INPUT NAME="RAW_EMAIL" DATATYPE="string" PRECISION="100"/>
  <INPUT NAME="RAW_ZIP_CODE" DATATYPE="string" PRECISION="10"/>
  
  <!-- Expression: Clean address -->
  <TRANSFORMATION NAME="EXP_CLEAN_ADDRESS" TYPE="Expression">
    <TRANSFORMFIELD NAME="CLEAN_ADDRESS" EXPR="TRIM(UPPER(RAW_ADDRESS))"/>
    <TRANSFORMFIELD NAME="ADDRESS_LENGTH" EXPR="LENGTH(CLEAN_ADDRESS)"/>
    <TRANSFORMFIELD NAME="IS_VALID_ADDRESS" EXPR="IIF(ADDRESS_LENGTH > 5 AND ADDRESS_LENGTH < 200, 1, 0)"/>
  </TRANSFORMATION>
  
  <!-- Expression: Clean phone -->
  <TRANSFORMATION NAME="EXP_CLEAN_PHONE" TYPE="Expression">
    <TRANSFORMFIELD NAME="PHONE_CLEAN" EXPR="REPLACE(REPLACE(REPLACE(REPLACE(RAW_PHONE, '-', ''), '(', ''), ')', ''), ' ', '')"/>
    <TRANSFORMFIELD NAME="PHONE_FORMATTED" EXPR="IIF(LENGTH(PHONE_CLEAN) = 10, '(' || SUBSTR(PHONE_CLEAN, 1, 3) || ') ' || SUBSTR(PHONE_CLEAN, 4, 3) || '-' || SUBSTR(PHONE_CLEAN, 7, 4), PHONE_CLEAN)"/>
    <TRANSFORMFIELD NAME="IS_VALID_PHONE" EXPR="IIF(LENGTH(PHONE_CLEAN) >= 10 AND LENGTH(PHONE_CLEAN) <= 15, 1, 0)"/>
  </TRANSFORMATION>
  
  <!-- Expression: Clean email -->
  <TRANSFORMATION NAME="EXP_CLEAN_EMAIL" TYPE="Expression">
    <TRANSFORMFIELD NAME="EMAIL_LOWER" EXPR="LOWER(TRIM(RAW_EMAIL))"/>
    <TRANSFORMFIELD NAME="EMAIL_AT_POS" EXPR="INSTR(EMAIL_LOWER, '@')"/>
    <TRANSFORMFIELD NAME="EMAIL_DOT_POS" EXPR="INSTR(EMAIL_LOWER, '.', EMAIL_AT_POS)"/>
    <TRANSFORMFIELD NAME="IS_VALID_EMAIL" EXPR="IIF(EMAIL_AT_POS > 0 AND EMAIL_DOT_POS > EMAIL_AT_POS AND EMAIL_DOT_POS < LENGTH(EMAIL_LOWER), 1, 0)"/>
    <TRANSFORMFIELD NAME="CLEAN_EMAIL" EXPR="IIF(IS_VALID_EMAIL = 1, EMAIL_LOWER, '')"/>
  </TRANSFORMATION>
  
  <!-- Expression: Clean zip code -->
  <TRANSFORMATION NAME="EXP_CLEAN_ZIP" TYPE="Expression">
    <TRANSFORMFIELD NAME="ZIP_CLEAN" EXPR="TRIM(RAW_ZIP_CODE)"/>
    <TRANSFORMFIELD NAME="ZIP_PADDED" EXPR="LPAD(ZIP_CLEAN, 5, '0')"/>
    <TRANSFORMFIELD NAME="IS_VALID_ZIP" EXPR="IIF(LENGTH(ZIP_PADDED) = 5 AND IS_NUMBER(ZIP_PADDED), 1, 0)"/>
  </TRANSFORMATION>
  
  <!-- Output Ports: Cleaned data fields -->
  <OUTPUT NAME="CLEAN_ADDRESS" DATATYPE="string" PRECISION="200"/>
  <OUTPUT NAME="IS_VALID_ADDRESS" DATATYPE="integer"/>
  <OUTPUT NAME="PHONE_FORMATTED" DATATYPE="string" PRECISION="20"/>
  <OUTPUT NAME="IS_VALID_PHONE" DATATYPE="integer"/>
  <OUTPUT NAME="CLEAN_EMAIL" DATATYPE="string" PRECISION="100"/>
  <OUTPUT NAME="IS_VALID_EMAIL" DATATYPE="integer"/>
  <OUTPUT NAME="ZIP_PADDED" DATATYPE="string" PRECISION="10"/>
  <OUTPUT NAME="IS_VALID_ZIP" DATATYPE="integer"/>
  
  <!-- Connectors within mapplet -->
  <CONNECTOR FROMINSTANCE="EXP_CLEAN_ADDRESS" FROMFIELD="CLEAN_ADDRESS" TOINSTANCE="OUTPUT" TOFIELD="CLEAN_ADDRESS"/>
  <CONNECTOR FROMINSTANCE="EXP_CLEAN_ADDRESS" FROMFIELD="IS_VALID_ADDRESS" TOINSTANCE="OUTPUT" TOFIELD="IS_VALID_ADDRESS"/>
  <CONNECTOR FROMINSTANCE="EXP_CLEAN_PHONE" FROMFIELD="PHONE_FORMATTED" TOINSTANCE="OUTPUT" TOFIELD="PHONE_FORMATTED"/>
  <CONNECTOR FROMINSTANCE="EXP_CLEAN_PHONE" FROMFIELD="IS_VALID_PHONE" TOINSTANCE="OUTPUT" TOFIELD="IS_VALID_PHONE"/>
  <CONNECTOR FROMINSTANCE="EXP_CLEAN_EMAIL" FROMFIELD="CLEAN_EMAIL" TOINSTANCE="OUTPUT" TOFIELD="CLEAN_EMAIL"/>
  <CONNECTOR FROMINSTANCE="EXP_CLEAN_EMAIL" FROMFIELD="IS_VALID_EMAIL" TOINSTANCE="OUTPUT" TOFIELD="IS_VALID_EMAIL"/>
  <CONNECTOR FROMINSTANCE="EXP_CLEAN_ZIP" FROMFIELD="ZIP_PADDED" TOINSTANCE="OUTPUT" TOFIELD="ZIP_PADDED"/>
  <CONNECTOR FROMINSTANCE="EXP_CLEAN_ZIP" FROMFIELD="IS_VALID_ZIP" TOINSTANCE="OUTPUT" TOFIELD="IS_VALID_ZIP"/>
  
</MAPPLET>

