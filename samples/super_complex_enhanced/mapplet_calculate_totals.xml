<?xml version="1.0"?>
<MAPPLET NAME="MPL_CALCULATE_TOTALS">
  <!-- Mapplet: Reusable calculation logic for order totals
       Purpose: Calculate subtotal, tax, shipping, and grand total
       Used in: Order processing mappings -->
  
  <!-- Input Ports -->
  <INPUT NAME="UNIT_PRICE" DATATYPE="decimal" PRECISION="10" SCALE="2"/>
  <INPUT NAME="QUANTITY" DATATYPE="integer"/>
  <INPUT NAME="DISCOUNT_PCT" DATATYPE="decimal" PRECISION="5" SCALE="2"/>
  <INPUT NAME="TAX_RATE" DATATYPE="decimal" PRECISION="5" SCALE="4"/>
  <INPUT NAME="SHIPPING_COST" DATATYPE="decimal" PRECISION="10" SCALE="2"/>
  
  <!-- Expression: Calculate line totals -->
  <TRANSFORMATION NAME="EXP_LINE_TOTALS" TYPE="Expression">
    <TRANSFORMFIELD NAME="LINE_SUBTOTAL" EXPR="UNIT_PRICE * QUANTITY"/>
    <TRANSFORMFIELD NAME="DISCOUNT_AMOUNT" EXPR="LINE_SUBTOTAL * (DISCOUNT_PCT / 100)"/>
    <TRANSFORMFIELD NAME="LINE_AFTER_DISCOUNT" EXPR="LINE_SUBTOTAL - DISCOUNT_AMOUNT"/>
  </TRANSFORMATION>
  
  <!-- Expression: Calculate tax and grand total -->
  <TRANSFORMATION NAME="EXP_FINAL_TOTALS" TYPE="Expression">
    <TRANSFORMFIELD NAME="TAX_AMOUNT" EXPR="LINE_AFTER_DISCOUNT * TAX_RATE"/>
    <TRANSFORMFIELD NAME="GRAND_TOTAL" EXPR="LINE_AFTER_DISCOUNT + TAX_AMOUNT + SHIPPING_COST"/>
  </TRANSFORMATION>
  
  <!-- Output Ports -->
  <OUTPUT NAME="LINE_SUBTOTAL" DATATYPE="decimal" PRECISION="10" SCALE="2"/>
  <OUTPUT NAME="DISCOUNT_AMOUNT" DATATYPE="decimal" PRECISION="10" SCALE="2"/>
  <OUTPUT NAME="LINE_AFTER_DISCOUNT" DATATYPE="decimal" PRECISION="10" SCALE="2"/>
  <OUTPUT NAME="TAX_AMOUNT" DATATYPE="decimal" PRECISION="10" SCALE="2"/>
  <OUTPUT NAME="GRAND_TOTAL" DATATYPE="decimal" PRECISION="10" SCALE="2"/>
  
  <!-- Connectors -->
  <CONNECTOR FROMINSTANCE="EXP_LINE_TOTALS" FROMFIELD="LINE_SUBTOTAL" TOINSTANCE="EXP_FINAL_TOTALS" TOFIELD="LINE_SUBTOTAL"/>
  <CONNECTOR FROMINSTANCE="EXP_LINE_TOTALS" FROMFIELD="LINE_AFTER_DISCOUNT" TOINSTANCE="EXP_FINAL_TOTALS" TOFIELD="LINE_AFTER_DISCOUNT"/>
  <CONNECTOR FROMINSTANCE="EXP_FINAL_TOTALS" FROMFIELD="LINE_SUBTOTAL" TOINSTANCE="OUTPUT" TOFIELD="LINE_SUBTOTAL"/>
  <CONNECTOR FROMINSTANCE="EXP_FINAL_TOTALS" FROMFIELD="DISCOUNT_AMOUNT" TOINSTANCE="OUTPUT" TOFIELD="DISCOUNT_AMOUNT"/>
  <CONNECTOR FROMINSTANCE="EXP_FINAL_TOTALS" FROMFIELD="LINE_AFTER_DISCOUNT" TOINSTANCE="OUTPUT" TOFIELD="LINE_AFTER_DISCOUNT"/>
  <CONNECTOR FROMINSTANCE="EXP_FINAL_TOTALS" FROMFIELD="TAX_AMOUNT" TOINSTANCE="OUTPUT" TOFIELD="TAX_AMOUNT"/>
  <CONNECTOR FROMINSTANCE="EXP_FINAL_TOTALS" FROMFIELD="GRAND_TOTAL" TOINSTANCE="OUTPUT" TOFIELD="GRAND_TOTAL"/>
  
</MAPPLET>

