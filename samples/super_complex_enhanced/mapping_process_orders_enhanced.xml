<?xml version="1.0"?>
<MAPPING NAME="M_PROCESS_ORDERS_ENHANCED">
  <!-- Mapping: Process orders with mapplet for calculations
       Demonstrates: Mapplet instance for reusable calculations -->
  
  <!-- Source Qualifiers -->
  <TRANSFORMATION NAME="SQ_ORDERS" TYPE="SourceQualifier">
    <ATTRIBUTE NAME="Sql Query" VALUE="SELECT * FROM STAGE_ORDERS"/>
  </TRANSFORMATION>
  
  <TRANSFORMATION NAME="SQ_ORDER_ITEMS" TYPE="SourceQualifier">
    <ATTRIBUTE NAME="Sql Query" VALUE="SELECT * FROM STAGE_ORDER_ITEMS"/>
  </TRANSFORMATION>
  
  <!-- Joiner: Join orders with items -->
  <TRANSFORMATION NAME="JNR_ORDERS_ITEMS" TYPE="Joiner">
    <JOINCONDITION LEFTFIELD="ORDER_ID" RIGHTFIELD="ORDER_ID" JOINTYPE="INNER"/>
  </TRANSFORMATION>
  
  <!-- Mapplet Instance: Calculate Totals -->
  <INSTANCE NAME="MPL_TOTALS_INST" MAPPLETNAME="MPL_CALCULATE_TOTALS">
    <!-- Input port mappings -->
    <MAPPLETINPUTINSTANCE PORTNAME="UNIT_PRICE" FROMINSTANCE="JNR_ORDERS_ITEMS" FROMFIELD="ITEM_PRICE"/>
    <MAPPLETINPUTINSTANCE PORTNAME="QUANTITY" FROMINSTANCE="JNR_ORDERS_ITEMS" FROMFIELD="QUANTITY"/>
    <MAPPLETINPUTINSTANCE PORTNAME="DISCOUNT_PCT" FROMINSTANCE="JNR_ORDERS_ITEMS" FROMFIELD="DISCOUNT_PERCENTAGE"/>
    <MAPPLETINPUTINSTANCE PORTNAME="TAX_RATE" FROMINSTANCE="JNR_ORDERS_ITEMS" FROMFIELD="TAX_RATE"/>
    <MAPPLETINPUTINSTANCE PORTNAME="SHIPPING_COST" FROMINSTANCE="JNR_ORDERS_ITEMS" FROMFIELD="SHIPPING_COST"/>
    <!-- Output port mappings -->
    <MAPPLETOUTPUTINSTANCE PORTNAME="GRAND_TOTAL" TOINSTANCE="AGG_ORDER_SUMMARY" TOFIELD="GRAND_TOTAL"/>
    <MAPPLETOUTPUTINSTANCE PORTNAME="DISCOUNT_AMOUNT" TOINSTANCE="AGG_ORDER_SUMMARY" TOFIELD="DISCOUNT_AMOUNT"/>
    <MAPPLETOUTPUTINSTANCE PORTNAME="TAX_AMOUNT" TOINSTANCE="AGG_ORDER_SUMMARY" TOFIELD="TAX_AMOUNT"/>
  </INSTANCE>
  
  <!-- Reusable Lookup: Product Information -->
  <TRANSFORMATION NAME="LK_PRODUCT_INFO" TYPE="Lookup" REUSABLE="YES" REUSABLENAME="LK_PRODUCT_INFO">
    <LOOKUPTABLE NAME="DIM_PRODUCT"/>
    <LOOKUPFIELD NAME="PRODUCT_ID" EXPR="PRODUCT_ID"/>
    <RETURNFIELD NAME="PRODUCT_NAME"/>
    <RETURNFIELD NAME="PRODUCT_CATEGORY"/>
    <RETURNFIELD NAME="SUPPLIER_NAME"/>
  </TRANSFORMATION>
  
  <!-- Aggregator: Aggregate by order -->
  <TRANSFORMATION NAME="AGG_ORDER_SUMMARY" TYPE="Aggregator">
    <TRANSFORMFIELD NAME="TOTAL_AMOUNT" EXPR="SUM(GRAND_TOTAL)"/>
    <TRANSFORMFIELD NAME="TOTAL_DISCOUNT" EXPR="SUM(DISCOUNT_AMOUNT)"/>
    <TRANSFORMFIELD NAME="TOTAL_TAX" EXPR="SUM(TAX_AMOUNT)"/>
    <TRANSFORMFIELD NAME="TOTAL_ITEMS" EXPR="SUM(QUANTITY)"/>
    <GROUPBYFIELD NAME="ORDER_ID"/>
  </TRANSFORMATION>
  
  <!-- Update Strategy -->
  <TRANSFORMATION NAME="UPD_STRATEGY" TYPE="UpdateStrategy">
    <ATTRIBUTE NAME="Update Strategy Expression" VALUE="DD_INSERT"/>
  </TRANSFORMATION>
  
  <!-- Target -->
  <TARGET NAME="PROCESSED_ORDERS" TYPE="Target">
    <TABLE NAME="PROCESSED_ORDERS" DATABASENAME="PROCESSING_DB"/>
  </TARGET>
  
  <!-- Connectors -->
  <CONNECTOR FROMINSTANCE="SQ_ORDERS" FROMFIELD="ORDER_ID" TOINSTANCE="JNR_ORDERS_ITEMS" TOFIELD="ORDER_ID"/>
  <CONNECTOR FROMINSTANCE="SQ_ORDER_ITEMS" FROMFIELD="ORDER_ID" TOINSTANCE="JNR_ORDERS_ITEMS" TOFIELD="ORDER_ID"/>
  <CONNECTOR FROMINSTANCE="JNR_ORDERS_ITEMS" FROMFIELD="PRODUCT_ID" TOINSTANCE="LK_PRODUCT_INFO" TOFIELD="PRODUCT_ID"/>
  <CONNECTOR FROMINSTANCE="AGG_ORDER_SUMMARY" FROMFIELD="*" TOINSTANCE="UPD_STRATEGY" TOFIELD="*"/>
  <CONNECTOR FROMINSTANCE="UPD_STRATEGY" FROMFIELD="*" TOINSTANCE="PROCESSED_ORDERS" TOFIELD="*"/>
  
</MAPPING>

